# docker-compose.yml 

services:
  # -----------------------------------------------------------
  # 1. FRONTEND (Image Nginx Statique)
  # -----------------------------------------------------------
  frontend:
    # ðŸŽ¯ Utilise le Dockerfile multi-Ã©tape de production
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: oneoone_frontend:latest
    container_name: oneoone_frontend
    env_file:
    - frontend/.env.production
    - frontend/.env.development
    depends_on:
      api_service:
        condition: service_started
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/"]
      interval: 10s
      timeout: 5s
      retries: 3
    # Mapper le port 80 du conteneur (Nginx) au port 80 de l'hÃ´te (Web standard)
    ports:
      - "8080:80"
    # Seul le Frontend a besoin d'Ãªtre exposÃ© publiquement
    networks:
      - backend_network

  # -----------------------------------------------------------
  # 2. BACKEND API (Uvicorn/FastAPI)
  # -----------------------------------------------------------
  api_service:
    # ðŸŽ¯ Utilise le Dockerfile multi-Ã©tape de production
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: oneoone_backend:latest
    container_name: oneoone_api
    # Lire les variables d'environnement de la DB distante/locale et Redis
    env_file:
      - ./backend/.env.local
    # IMPORTANT: DÃ©marre APRÃˆS Redis et (si local) PostgreSQL
    depends_on:
      redis_cache : 
        condition: service_healthy
      postgres_db : 
        condition: service_healthy
    restart: always
    networks:
      - backend_network
      
  # -----------------------------------------------------------
  # 3. REDIS (Cache et Messages WebSocket)
  # -----------------------------------------------------------
  redis_cache:
    image: redis:7-alpine
    container_name: oneoone_redis
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    # Persistance des donnÃ©es de cache Redis
    volumes:
      - redis_data:/data
    # N'expose PAS son port 6379 publiquement.
    networks:
      - backend_network
  
  # -----------------------------------------------------------------
  # 4. Base de DonnÃ©es Relationnelle (VÃ©ritÃ©)
  # -----------------------------------------------------------------
  postgres_db:
    image: postgres:16-alpine
    container_name: oneoone_postgres
    environment:
      POSTGRES_USER: user_db
      POSTGRES_PASSWORD: password
      POSTGRES_DB: oneoone_db
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user_db -d oneoone_db"]
      interval: 5s
      timeout: 5s
      retries: 5
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - backend_network 


# -----------------------------------------------------------
# DÃ‰FINITIONS GLOBALES
# -----------------------------------------------------------
volumes:
  # Volume pour les donnÃ©es de Redis (le cache)
  redis_data:    
  postgres_data: 
    driver: local 

networks:
  backend_network:
    driver: bridge 
