# docker-compose.yml 

services:
  # -----------------------------------------------------------
  # 1. FRONTEND (Image Nginx Statique)
  # -----------------------------------------------------------
  frontend:
    # üéØ Utilise le Dockerfile multi-√©tape de production
    build:
      context: ./frontend
      dockerfile: Dockerfile
    image: oneoone_frontend:latest
    container_name: oneoone_frontend
    env_file:
    - frontend/.env.production
    - frontend/.env.development

    # Mapper le port 80 du conteneur (Nginx) au port 80 de l'h√¥te (Web standard)
    ports:
      - "8080:80"
    # Seul le Frontend a besoin d'√™tre expos√© publiquement
    networks:
      - backend_network

  # -----------------------------------------------------------
  # 2. BACKEND API (Uvicorn/FastAPI)
  # -----------------------------------------------------------
  api_service:
    # üéØ Utilise le Dockerfile multi-√©tape de production
    build:
      context: ./backend
      dockerfile: Dockerfile
    image: oneoone_backend:latest
    container_name: oneoone_api
    # Lire les variables d'environnement de la DB distante/locale et Redis
    env_file:
      - ./backend/.env.local
      
    # IMPORTANT: D√©marre APR√àS Redis et (si local) PostgreSQL
    depends_on:
      - redis_cache
      # - postgres_db # Si vous utilisez une DB locale
      
    # N'expose PAS son port 8000 publiquement. Il est accessible uniquement via le r√©seau interne.
    networks:
      - backend_network
      
  # -----------------------------------------------------------
  # 3. REDIS (Cache et Messages WebSocket)
  # -----------------------------------------------------------
  redis_cache:
    image: redis:7-alpine
    container_name: oneoone_redis
    
    # Persistance des donn√©es de cache Redis
    volumes:
      - redis_data:/data

      
    # N'expose PAS son port 6379 publiquement.
    networks:
      - backend_network
  
  # -----------------------------------------------------------------
  # 4. Base de Donn√©es Relationnelle (V√©rit√©)
  # -----------------------------------------------------------------
  postgres_db:
    image: postgres:16-alpine
    container_name: oneoone_postgres
    environment:
      POSTGRES_USER: user_db
      POSTGRES_PASSWORD: password
      POSTGRES_DB: oneoone_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - backend_network 

  # postgres_db_dev:
  #   image: postgres:16-alpine
  #   container_name: oneoone_postgres_dev
  #   environment:
  #     POSTGRES_USER: user_db
  #     POSTGRES_PASSWORD: password
  #     POSTGRES_DB: oneoone_db

  #   ports:
  #     - "5433:5432"
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data


  # redis_cache_dev:
  #   image: redis:7-alpine
  #   container_name: oneoone_redis_dev
    
  #   # Persistance des donn√©es de cache Redis
  #   volumes:
  #     - redis_data:/data

  #   ports:
  #     - "6379:6379"
      




# -----------------------------------------------------------
# D√âFINITIONS GLOBALES
# -----------------------------------------------------------
volumes:
  # Volume pour les donn√©es de Redis (le cache)
  redis_data:
    # driver: local (implicite si pas de service cloud)
    
  # Si vous d√©cidez de revenir √† une DB locale en production :
  postgres_data: 
    driver: local 
  #   # Ou un driver distant pour le cloud, comme RexRay ou un pilote NFS

networks:
  # Le r√©seau par d√©faut qui isole les services et permet la communication par nom
  backend_network:
    driver: bridge # Le type de r√©seau par d√©faut pour l'isolation